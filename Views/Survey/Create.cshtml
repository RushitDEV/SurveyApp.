@model SurveyApp.Models.Survey

@{
    ViewData["Title"] = "Yeni Anket Oluştur";
}

<div class="container-fluid p-0 bg-light min-vh-100">
    <!-- Header -->
    <div class="bg-white border-bottom sticky-top">
        <div class="container py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a asp-action="Index" class="btn btn-light me-3">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                    <h4 class="mb-0">Yeni Anket</h4>
                </div>
                <button type="button" onclick="saveSurvey()" class="btn btn-primary px-4">
                    <i class="bi bi-check-lg me-2"></i>Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Survey Info Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <label class="form-label fw-bold">Anket Başlığı *</label>
                            <input id="surveyTitle" type="text" class="form-control form-control-lg border-0 bg-light"
                                   placeholder="Örn: Müşteri Memnuniyet Anketi" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Açıklama</label>
                            <textarea id="surveyDescription" class="form-control border-0 bg-light"
                                      rows="3" placeholder="Anketiniz hakkında kısa bir açıklama yazın..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Bitiş Tarihi (Opsiyonel)</label>
                                <input id="surveyEndDate" type="date" class="form-control border-0 bg-light" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Durum</label>
                                <select id="surveyIsActive" class="form-select border-0 bg-light">
                                    <option value="true" selected>Aktif</option>
                                    <option value="false">Pasif</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questions Section -->
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0 fw-bold">Sorular</h5>
                            <button type="button" class="btn btn-outline-primary" onclick="addQuestion()">
                                <i class="bi bi-plus-lg me-2"></i>Soru Ekle
                            </button>
                        </div>
                        <div id="questionsContainer">
                            <div class="text-center py-5 text-muted" id="emptyState">
                                <i class="bi bi-question-circle" style="font-size: 3rem;"></i>
                                <p class="mt-3">Henüz soru eklenmedi</p>
                                <p class="small">Soru eklemek için yukarıdaki butona tıklayın</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let questionCount = 0;
    let questions = [];

    const questionTypes = {
        1: { name: 'Tek Seçmeli', icon: 'bi-circle', needsOptions: true },
        2: { name: 'Çok Seçmeli', icon: 'bi-check-square', needsOptions: true },
        3: { name: 'Açık Uçlu', icon: 'bi-text-left', needsOptions: false },
        4: { name: 'Kısa Metin', icon: 'bi-dash-lg', needsOptions: false },
        5: { name: 'Resim Eklemeli', icon: 'bi-image', needsOptions: false },
        6: { name: 'Dosya Yükleme', icon: 'bi-file-earmark-arrow-up', needsOptions: false },
        7: { name: 'Tarih', icon: 'bi-calendar-event', needsOptions: false },
        8: { name: 'Sayısal', icon: 'bi-123', needsOptions: false },
        9: { name: 'Derecelendirme (1-5)', icon: 'bi-star', needsOptions: false },
        10: { name: 'Derecelendirme (1-10)', icon: 'bi-star-half', needsOptions: false }
    };

    function addQuestion() {
        questionCount++;
        const container = document.getElementById('questionsContainer');
        const emptyState = document.getElementById('emptyState');

        if (emptyState) {
            emptyState.remove();
        }

        const questionHtml = `
            <div class="question-card border rounded p-4 mb-3 bg-white" id="question_${questionCount}" data-question-id="${questionCount}">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-grip-vertical me-2"></i>Soru ${questionCount}
                    </h6>
                    <button type="button" class="btn btn-sm btn-link text-danger" onclick="removeQuestion(${questionCount})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Soru Metni</label>
                    <input type="text" class="form-control mb-3 border-0 bg-light question-text"
                           placeholder="Sorunuzu buraya yazın..." data-question-id="${questionCount}" required />
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Soru Tipi</label>
                    <select class="form-select border-0 bg-light question-type" data-question-id="${questionCount}" onchange="handleTypeChange(${questionCount}, this.value)">
                        <optgroup label="Seçmeli Sorular">
                            <option value="1">📋 Tek Seçmeli</option>
                            <option value="2">☑️ Çok Seçmeli</option>
                        </optgroup>
                        <optgroup label="Metin Girişi">
                            <option value="3">📝 Açık Uçlu (Uzun Metin)</option>
                            <option value="4">✏️ Kısa Metin</option>
                        </optgroup>
                        <optgroup label="Medya">
                            <option value="5">🖼️ Resim Eklemeli</option>
                            <option value="6">📎 Dosya Yükleme</option>
                        </optgroup>
                        <optgroup label="Sayısal/Tarih">
                            <option value="7">📅 Tarih Seçimi</option>
                            <option value="8">🔢 Sayısal Giriş</option>
                        </optgroup>
                        <optgroup label="Derecelendirme">
                            <option value="9">⭐ Derecelendirme (1-5)</option>
                            <option value="10">⭐ Derecelendirme (1-10)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="options-container" id="options_${questionCount}">
                    <div class="mb-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addOption(${questionCount})">
                            <i class="bi bi-plus me-1"></i>Seçenek Ekle
                        </button>
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', questionHtml);
    }

    function handleTypeChange(questionId, type) {
        const optionsContainer = document.getElementById(`options_${questionId}`);
        const typeInt = parseInt(type);
        const typeInfo = questionTypes[typeInt];

        if (!typeInfo.needsOptions) {
            // Seçeneksiz soru tipleri için bilgilendirme
            const descriptions = {
                3: '📝 Kullanıcılar uzun metin yazabilir (textarea)',
                4: '✏️ Kullanıcılar kısa metin girebilir (tek satır)',
                5: '🖼️ Kullanıcılar resim dosyası yükleyebilir (JPG, PNG)',
                6: '📎 Kullanıcılar dosya yükleyebilir (PDF, DOC, vb.)',
                7: '📅 Kullanıcılar tarih seçebilir',
                8: '🔢 Kullanıcılar sadece sayı girebilir',
                9: '⭐ Kullanıcılar 1-5 arası yıldız verebilir',
                10: '⭐ Kullanıcılar 1-10 arası puan verebilir'
            };

            optionsContainer.innerHTML = `
                <div class="alert alert-info d-flex align-items-center mb-0" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <div>${descriptions[typeInt]}</div>
                </div>
            `;
        } else {
            // Seçenekli soru tipleri
            optionsContainer.innerHTML = `
                <div class="mb-2">
                    <label class="form-label small text-muted">Seçenekler</label>
                    <button type="button" class="btn btn-sm btn-outline-secondary d-block mb-2" onclick="addOption(${questionId})">
                        <i class="bi bi-plus me-1"></i>Seçenek Ekle
                    </button>
                </div>
            `;
        }
    }

    function addOption(questionId) {
        const optionsContainer = document.getElementById(`options_${questionId}`);
        const optionCount = optionsContainer.querySelectorAll('.option-input').length + 1;

        const optionHtml = `
            <div class="input-group mb-2 option-input">
                <span class="input-group-text bg-light border-0">
                    <i class="bi bi-circle me-1"></i>${optionCount}
                </span>
                <input type="text" class="form-control border-0 bg-light" placeholder="Seçenek ${optionCount}" />
                <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove(); renumberOptions(${questionId})">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;

        const button = optionsContainer.querySelector('button');
        button.insertAdjacentHTML('beforebegin', optionHtml);
    }

    function renumberOptions(questionId) {
        const optionsContainer = document.getElementById(`options_${questionId}`);
        const options = optionsContainer.querySelectorAll('.option-input');
        options.forEach((option, index) => {
            const span = option.querySelector('.input-group-text');
            span.innerHTML = `<i class="bi bi-circle me-1"></i>${index + 1}`;
            const input = option.querySelector('input');
            input.placeholder = `Seçenek ${index + 1}`;
        });
    }

    function removeQuestion(id) {
        if (confirm('Bu soruyu silmek istediğinize emin misiniz?')) {
            document.getElementById('question_' + id).remove();
            questionCount--;

            const container = document.getElementById('questionsContainer');
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted" id="emptyState">
                        <i class="bi bi-question-circle" style="font-size: 3rem;"></i>
                        <p class="mt-3">Henüz soru eklenmedi</p>
                        <p class="small">Soru eklemek için yukarıdaki butona tıklayın</p>
                    </div>
                `;
            }
        }
    }

    function saveSurvey() {
        const title = document.getElementById('surveyTitle').value;
        const description = document.getElementById('surveyDescription').value;
        const endDate = document.getElementById('surveyEndDate').value;
        const isActive = document.getElementById('surveyIsActive').value === 'true';

        if (!title) {
            alert('⚠️ Lütfen anket başlığı girin!');
            return;
        }

        // Soruları topla
        const questions = [];
        document.querySelectorAll('.question-card').forEach(card => {
            const questionId = card.dataset.questionId;
            const questionText = card.querySelector('.question-text').value;
            const questionType = parseInt(card.querySelector('.question-type').value);

            if (!questionText) {
                alert(`⚠️ Soru ${questionId} için soru metni boş bırakılamaz!`);
                return;
            }

            const question = {
                questionText: questionText,
                type: questionType,
                options: []
            };

            // Seçenekleri topla (eğer seçenekli soru tipiyse)
            if (questionTypes[questionType].needsOptions) {
                card.querySelectorAll('.option-input input').forEach(input => {
                    if (input.value) {
                        question.options.push(input.value);
                    }
                });

                if (question.options.length < 2) {
                    alert(`⚠️ Soru ${questionId} için en az 2 seçenek eklemelisiniz!`);
                    return;
                }
            }

            questions.push(question);
        });

        if (questions.length === 0) {
            alert('⚠️ En az bir soru eklemelisiniz!');
            return;
        }

        const data = {
            title: title,
            description: description,
            endDate: endDate || null,
            isActive: isActive,
            questions: questions
        };

        // Kaydetme işlemi
        console.log('Gönderilen veri:', data);

        fetch('/Survey/Create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Anket başarıyla oluşturuldu!');
                window.location.href = '/Survey/Index';
            } else {
                alert('❌ Bir hata oluştu: ' + (data.message || 'Bilinmeyen hata'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Bir hata oluştu! Lütfen tekrar deneyin.');
        });
    }
</script>

<style>
    .question-card {
        transition: all 0.3s ease;
        border-left: 4px solid #0d6efd;
    }

        .question-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

    .option-input {
        transition: all 0.2s ease;
    }

        .option-input:hover {
            background-color: #f8f9fa;
        }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
    }
</style>