@{
    ViewData["Title"] = "Yeni Anket Oluştur";
}

<div class="container-fluid p-0 bg-light min-vh-100">
    <!-- Header -->
    <div class="bg-white border-bottom sticky-top">
        <div class="container py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a asp-action="Index" class="btn btn-light me-3">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                    <h4 class="mb-0">Yeni Anket</h4>
                </div>
                <button type="button" onclick="saveSurvey()" class="btn btn-primary px-4">
                    <i class="bi bi-check-lg me-2"></i>Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Survey Info Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <label class="form-label fw-bold">Anket Başlığı *</label>
                            <input id="surveyTitle" type="text" class="form-control form-control-lg border-0 bg-light"
                                   placeholder="Örn: Müşteri Memnuniyet Anketi" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Açıklama</label>
                            <textarea id="surveyDescription" class="form-control border-0 bg-light"
                                      rows="3" placeholder="Anketiniz hakkında kısa bir açıklama yazın..."></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Bitiş Tarihi (Opsiyonel)</label>
                                <input id="surveyEndDate" type="date" class="form-control border-0 bg-light" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Durum</label>
                                <select id="surveyIsActive" class="form-select border-0 bg-light">
                                    <option value="true" selected>Aktif</option>
                                    <option value="false">Pasif</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questions Section -->
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0 fw-bold">Sorular</h5>
                            <button type="button" class="btn btn-outline-primary" onclick="addQuestion()">
                                <i class="bi bi-plus-lg me-2"></i>Soru Ekle
                            </button>
                        </div>
                        <div id="questionsContainer">
                            <div class="text-center py-5 text-muted" id="emptyState">
                                <i class="bi bi-question-circle" style="font-size: 3rem;"></i>
                                <p class="mt-3">Henüz soru eklenmedi</p>
                                <p class="small">Soru eklemek için yukarıdaki butona tıklayın</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let questionCount = 0;
    
    // ✅ String-based question types
    const questionTypes = {
        'SingleChoice': { name: 'Tek Seçmeli', icon: 'bi-circle', needsOptions: true },
        'MultipleChoice': { name: 'Çok Seçmeli', icon: 'bi-check-square', needsOptions: true },
        'OpenEnded': { name: 'Açık Uçlu', icon: 'bi-text-left', needsOptions: false },
        'ShortText': { name: 'Kısa Metin', icon: 'bi-dash-lg', needsOptions: false },
        'ImageUpload': { name: 'Resim Eklemeli', icon: 'bi-image', needsOptions: false },
        'FileUpload': { name: 'Dosya Yükleme', icon: 'bi-file-earmark-arrow-up', needsOptions: false },
        'DatePicker': { name: 'Tarih', icon: 'bi-calendar-event', needsOptions: false },
        'Number': { name: 'Sayısal', icon: 'bi-123', needsOptions: false },
        'Rating5': { name: 'Derecelendirme (1-5)', icon: 'bi-star', needsOptions: false },
        'Rating10': { name: 'Derecelendirme (1-10)', icon: 'bi-star-half', needsOptions: false }
    };

    function addQuestion() {
        questionCount++;
        const container = document.getElementById('questionsContainer');
        const emptyState = document.getElementById('emptyState');
        if (emptyState) emptyState.remove();

        const html = `
        <div class="question-card border rounded p-4 mb-3 bg-white" id="question_${questionCount}">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h6 class="fw-bold text-primary"><i class="bi bi-grip-vertical me-2"></i>Soru ${questionCount}</h6>
                <button class="btn btn-sm btn-link text-danger" onclick="removeQuestion(${questionCount})"><i class="bi bi-trash"></i></button>
            </div>
            <div class="mb-3">
                <label class="form-label small text-muted">Soru Metni</label>
                <input type="text" class="form-control border-0 bg-light question-text" placeholder="Sorunuzu buraya yazın..." required />
            </div>
            <div class="mb-3">
                <label class="form-label small text-muted">Soru Tipi</label>
                <select class="form-select border-0 bg-light question-type" onchange="handleTypeChange(${questionCount}, this.value)">
                    <optgroup label="Seçmeli Sorular">
                        <option value="SingleChoice">📋 Tek Seçmeli</option>
                        <option value="MultipleChoice">☑️ Çok Seçmeli</option>
                    </optgroup>
                    <optgroup label="Metin Girişi">
                        <option value="OpenEnded">📝 Açık Uçlu</option>
                        <option value="ShortText">✏️ Kısa Metin</option>
                    </optgroup>
                    <optgroup label="Medya">
                        <option value="ImageUpload">🖼️ Resim Eklemeli</option>
                        <option value="FileUpload">📎 Dosya Yükleme</option>
                    </optgroup>
                    <optgroup label="Sayısal/Tarih">
                        <option value="DatePicker">📅 Tarih Seçimi</option>
                        <option value="Number">🔢 Sayısal Giriş</option>
                    </optgroup>
                    <optgroup label="Derecelendirme">
                        <option value="Rating5">⭐ Derecelendirme (1-5)</option>
                        <option value="Rating10">⭐ Derecelendirme (1-10)</option>
                    </optgroup>
                </select>
            </div>
            <div class="options-container" id="options_${questionCount}">
                <div class="mb-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addOption(${questionCount})">
                        <i class="bi bi-plus me-1"></i>Seçenek Ekle
                    </button>
                </div>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    function handleTypeChange(qId, type) {
        const optionsContainer = document.getElementById(`options_${qId}`);
        const typeInfo = questionTypes[type];

        if (!typeInfo.needsOptions) {
            optionsContainer.innerHTML = `<div class="alert alert-info mb-0">
                <i class="bi bi-info-circle me-2"></i>${typeInfo.name} tipi soru seçenek gerektirmez.
            </div>`;
        } else {
            optionsContainer.innerHTML = `
            <div class="mb-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addOption(${qId})">
                    <i class="bi bi-plus me-1"></i>Seçenek Ekle
                </button>
            </div>`;
        }
    }

    function addOption(qId) {
        const optionsContainer = document.getElementById(`options_${qId}`);
        const optionCount = optionsContainer.querySelectorAll('.option-input').length + 1;
        const html = `
        <div class="input-group mb-2 option-input">
            <span class="input-group-text bg-light border-0">${optionCount}</span>
            <input type="text" class="form-control border-0 bg-light" placeholder="Seçenek ${optionCount}" />
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove(); renumberOptions(${qId})">
                <i class="bi bi-x"></i>
            </button>
        </div>`;
        const button = optionsContainer.querySelector('button');
        button.insertAdjacentHTML('beforebegin', html);
    }

    function renumberOptions(qId) {
        const options = document.querySelectorAll(`#options_${qId} .option-input`);
        options.forEach((opt, i) => {
            opt.querySelector('.input-group-text').textContent = i + 1;
            opt.querySelector('input').placeholder = `Seçenek ${i + 1}`;
        });
    }

    function removeQuestion(id) {
        document.getElementById('question_' + id)?.remove();
        const container = document.getElementById('questionsContainer');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5 text-muted" id="emptyState">
                    <i class="bi bi-question-circle" style="font-size: 3rem;"></i>
                    <p class="mt-3">Henüz soru eklenmedi</p>
                    <p class="small">Soru eklemek için yukarıdaki butona tıklayın</p>
                </div>
            `;
        }
    }

    function saveSurvey() {
        const title = document.getElementById('surveyTitle').value;
        const description = document.getElementById('surveyDescription').value;
        const endDate = document.getElementById('surveyEndDate').value;
        const isActive = document.getElementById('surveyIsActive').value === 'true';

        if (!title) {
            alert('⚠️ Lütfen anket başlığı girin!');
            return;
        }

        const questions = [];
        document.querySelectorAll('.question-card').forEach((card, i) => {
            const questionText = card.querySelector('.question-text').value;
            const questionType = card.querySelector('.question-type').value; // ✅ Artık string

            if (!questionText) return;

            const q = {
                questionText,
                type: questionType, // ✅ Doğrudan string gönder
                isRequired: true,
                options: []
            };

            if (questionTypes[questionType].needsOptions) {
                card.querySelectorAll('.option-input input').forEach(input => {
                    if (input.value) q.options.push({ optionText: input.value });
                });
            }

            questions.push(q);
        });

        if (questions.length === 0) {
            alert('⚠️ Lütfen en az bir soru ekleyin!');
            return;
        }

        const data = { title, description, endDate: endDate || null, isActive, questions };
        console.log('Gönderilen veri:', data);

        fetch('/Survey/Create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            if (res.success) {
                alert('✅ Anket başarıyla oluşturuldu!');
                window.location.href = '/Survey/Index';
            } else alert('❌ Hata: ' + (res.message || 'Bilinmeyen hata'));
        })
        .catch(err => {
            console.error(err);
            alert('❌ Sunucuya bağlanılamadı.');
        });
    }
</script>

<style>
    .question-card {
        border-left: 4px solid #0d6efd;
        transition: 0.3s;
    }

        .question-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 .2rem rgba(13,110,253,.25);
    }
</style>