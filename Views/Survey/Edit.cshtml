@model SurveyApp.ViewModels.SurveyCreateEditViewModel
@{
    ViewData["Title"] = "Anketi Düzenle";
}

<div class="container-fluid p-0 bg-light min-vh-100">
    <!-- Header -->
    <div class="bg-white border-bottom sticky-top">
        <div class="container py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-light me-3">
                        <i class="bi bi-arrow-left"></i>
                    </a>
                    <h4 class="mb-0">Anketi Düzenle</h4>
                </div>
                <button type="button" onclick="updateSurvey()" class="btn btn-primary px-4">
                    <i class="bi bi-check-lg me-2"></i>Güncelle
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Survey Info Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <label class="form-label fw-bold">Anket Başlığı *</label>
                            <input id="surveyTitle" type="text" class="form-control form-control-lg border-0 bg-light"
                                   value="@Model.Title" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Açıklama</label>
                            <textarea id="surveyDescription" class="form-control border-0 bg-light"
                                      rows="3">@Model.Description</textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Bitiş Tarihi (Opsiyonel)</label>
                                <input id="surveyEndDate" type="date" class="form-control border-0 bg-light"
                                       value="@(Model.EndDate?.ToString("yyyy-MM-dd"))"
                                       min="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")" />
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Boş bırakırsanız anket süresiz olur
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Durum</label>
                                <select id="surveyIsActive" class="form-select border-0 bg-light">
                                    @if (Model.IsActive)
                                    {
                                        <option value="true" selected>Aktif</option>
                                        <option value="false">Pasif</option>
                                    }
                                    else
                                    {
                                        <option value="true">Aktif</option>
                                        <option value="false" selected>Pasif</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Questions Section -->
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0 fw-bold">Sorular</h5>
                            <button type="button" class="btn btn-outline-primary" onclick="addQuestion()">
                                <i class="bi bi-plus-lg me-2"></i>Soru Ekle
                            </button>
                        </div>
                        <div id="questionsContainer">
                            @if (!Model.Questions.Any())
                            {
                                <div class="text-center py-5 text-muted" id="emptyState">
                                    <i class="bi bi-question-circle" style="font-size: 3rem;"></i>
                                    <p class="mt-3">Henüz soru eklenmedi</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let questionCount = @Model.Questions.Count;

    // ✅ String-based question types
    const questionTypes = {
        'SingleChoice': { name: 'Tek Seçmeli', needsOptions: true },
        'MultipleChoice': { name: 'Çok Seçmeli', needsOptions: true },
        'OpenEnded': { name: 'Açık Uçlu', needsOptions: false },
        'ShortText': { name: 'Kısa Metin', needsOptions: false },
        'ImageUpload': { name: 'Resim Eklemeli', needsOptions: false },
        'FileUpload': { name: 'Dosya Yükleme', needsOptions: false },
        'DatePicker': { name: 'Tarih', needsOptions: false },
        'Number': { name: 'Sayısal', needsOptions: false },
        'Rating5': { name: 'Derecelendirme (1-5)', needsOptions: false },
        'Rating10': { name: 'Derecelendirme (1-10)', needsOptions: false }
    };

    // Mevcut soruları yükle
    window.addEventListener('DOMContentLoaded', function () {
        @foreach (var question in Model.Questions.OrderBy(q => q.Order))
        {
                <text>
                loadExistingQuestion(
                    '@Html.Raw(question.QuestionText.Replace("'", "\\'"))',
                    '@question.Type',
                    [@string.Join(",", question.Options.Select(o => "'" + Html.Raw(o.OptionText.Replace("'", "\\'")) + "'"))]
                );
                </text>
        }
    });

    function loadExistingQuestion(text, type, options) {
        questionCount++;
        const container = document.getElementById('questionsContainer');
        const emptyState = document.getElementById('emptyState');

        if (emptyState) {
            emptyState.remove();
        }

        const questionHtml = createQuestionHtml(questionCount, text, type);
        container.insertAdjacentHTML('beforeend', questionHtml);

        // Seçenekleri yükle
        if (questionTypes[type].needsOptions && options.length > 0) {
            const optionsContainer = document.getElementById(`options_${questionCount}`);
            optionsContainer.innerHTML = `
                <div class="mb-2">
                    <label class="form-label small text-muted">Seçenekler</label>
                    <button type="button" class="btn btn-sm btn-outline-secondary d-block mb-2" onclick="addOption(${questionCount})">
                        <i class="bi bi-plus me-1"></i>Seçenek Ekle
                    </button>
                </div>
            `;

            options.forEach((opt, index) => {
                const optionHtml = `
                    <div class="input-group mb-2 option-input">
                        <span class="input-group-text bg-light border-0">${index + 1}</span>
                        <input type="text" class="form-control border-0 bg-light" value="${opt}" />
                        <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove(); renumberOptions(${questionCount})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
                const button = optionsContainer.querySelector('button');
                button.insertAdjacentHTML('beforebegin', optionHtml);
            });
        } else {
            handleTypeChange(questionCount, type);
        }
    }

    function createQuestionHtml(id, text = '', type = 'SingleChoice') {
        return `
            <div class="question-card border rounded p-4 mb-3 bg-white" id="question_${id}" data-question-id="${id}">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="mb-0 fw-bold text-primary">
                        <i class="bi bi-grip-vertical me-2"></i>Soru ${id}
                    </h6>
                    <button type="button" class="btn btn-sm btn-link text-danger" onclick="removeQuestion(${id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Soru Metni</label>
                    <input type="text" class="form-control border-0 bg-light question-text"
                           value="${text}" placeholder="Sorunuzu buraya yazın..." data-question-id="${id}" required />
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Soru Tipi</label>
                    <select class="form-select border-0 bg-light question-type" data-question-id="${id}" onchange="handleTypeChange(${id}, this.value)">
                        <optgroup label="Seçmeli Sorular">
                            <option value="SingleChoice" ${type === 'SingleChoice' ? 'selected' : ''}>Tek Seçmeli</option>
                            <option value="MultipleChoice" ${type === 'MultipleChoice' ? 'selected' : ''}>Çok Seçmeli</option>
                        </optgroup>
                        <optgroup label="Metin Girişi">
                            <option value="OpenEnded" ${type === 'OpenEnded' ? 'selected' : ''}>Açık Uçlu (Uzun Metin)</option>
                            <option value="ShortText" ${type === 'ShortText' ? 'selected' : ''}>Kısa Metin</option>
                        </optgroup>
                        <optgroup label="Medya">
                            <option value="ImageUpload" ${type === 'ImageUpload' ? 'selected' : ''}>Resim Eklemeli</option>
                            <option value="FileUpload" ${type === 'FileUpload' ? 'selected' : ''}>Dosya Yükleme</option>
                        </optgroup>
                        <optgroup label="Sayısal/Tarih">
                            <option value="DatePicker" ${type === 'DatePicker' ? 'selected' : ''}>Tarih Seçimi</option>
                            <option value="Number" ${type === 'Number' ? 'selected' : ''}>Sayısal Giriş</option>
                        </optgroup>
                        <optgroup label="Derecelendirme">
                            <option value="Rating5" ${type === 'Rating5' ? 'selected' : ''}>Derecelendirme (1-5)</option>
                            <option value="Rating10" ${type === 'Rating10' ? 'selected' : ''}>Derecelendirme (1-10)</option>
                        </optgroup>
                    </select>
                </div>
                <div class="options-container" id="options_${id}"></div>
            </div>
        `;
    }

    function addQuestion() {
        questionCount++;
        const container = document.getElementById('questionsContainer');
        const emptyState = document.getElementById('emptyState');
        if (emptyState) emptyState.remove();

        const questionHtml = createQuestionHtml(questionCount);
        container.insertAdjacentHTML('beforeend', questionHtml);
        handleTypeChange(questionCount, 'SingleChoice');
    }

    function handleTypeChange(questionId, type) {
        const optionsContainer = document.getElementById(`options_${questionId}`);
        const typeInfo = questionTypes[type];

        if (!typeInfo.needsOptions) {
            const descriptions = {
                'OpenEnded': 'Kullanıcılar uzun metin yazabilir (textarea)',
                'ShortText': 'Kullanıcılar kısa metin girebilir (tek satır)',
                'ImageUpload': 'Kullanıcılar resim dosyası yükleyebilir (JPG, PNG)',
                'FileUpload': 'Kullanıcılar dosya yükleyebilir (PDF, DOC, vb.)',
                'DatePicker': 'Kullanıcılar tarih seçebilir',
                'Number': 'Kullanıcılar sadece sayı girebilir',
                'Rating5': 'Kullanıcılar 1-5 arası yıldız verebilir',
                'Rating10': 'Kullanıcılar 1-10 arası puan verebilir'
            };

            optionsContainer.innerHTML = `
                <div class="alert alert-info d-flex align-items-center mb-0" role="alert">
                    <i class="bi bi-info-circle me-2"></i>
                    <div>${descriptions[type]}</div>
                </div>
            `;
        } else {
            optionsContainer.innerHTML = `
                <div class="mb-2">
                    <label class="form-label small text-muted">Seçenekler</label>
                    <button type="button" class="btn btn-sm btn-outline-secondary d-block mb-2" onclick="addOption(${questionId})">
                        <i class="bi bi-plus me-1"></i>Seçenek Ekle
                    </button>
                </div>
            `;
        }
    }

    function addOption(questionId) {
        const optionsContainer = document.getElementById(`options_${questionId}`);
        const optionCount = optionsContainer.querySelectorAll('.option-input').length + 1;

        const optionHtml = `
            <div class="input-group mb-2 option-input">
                <span class="input-group-text bg-light border-0">${optionCount}</span>
                <input type="text" class="form-control border-0 bg-light" placeholder="Seçenek ${optionCount}" />
                <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove(); renumberOptions(${questionId})">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
        const button = optionsContainer.querySelector('button');
        button.insertAdjacentHTML('beforebegin', optionHtml);
    }

    function renumberOptions(questionId) {
        const optionsContainer = document.getElementById(`options_${questionId}`);
        const options = optionsContainer.querySelectorAll('.option-input');
        options.forEach((option, index) => {
            option.querySelector('.input-group-text').textContent = index + 1;
            option.querySelector('input').placeholder = `Seçenek ${index + 1}`;
        });
    }

    function removeQuestion(id) {
        if (confirm('Bu soruyu silmek istediğinize emin misiniz?')) {
            document.getElementById(`question_${id}`).remove();
            const container = document.getElementById('questionsContainer');
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 text-muted" id="emptyState">
                        <i class="bi bi-question-circle" style="font-size: 3rem;"></i>
                        <p class="mt-3">Henüz soru eklenmedi</p>
                    </div>
                `;
            }
        }
    }

    function updateSurvey() {
        const title = document.getElementById('surveyTitle').value;
        const description = document.getElementById('surveyDescription').value;
        const endDate = document.getElementById('surveyEndDate').value;
        const isActive = document.getElementById('surveyIsActive').value === 'true';

        if (!title) {
            alert('⚠️ Lütfen anket başlığı girin!');
            return;
        }

        const questions = [];
        document.querySelectorAll('.question-card').forEach(card => {
            const questionText = card.querySelector('.question-text').value;
            const questionType = card.querySelector('.question-type').value; // ✅ Artık string

            if (!questionText) return;

            const question = {
                questionText: questionText,
                type: questionType, // ✅ String olarak gönder
                options: []
            };

            if (questionTypes[questionType].needsOptions) {
                card.querySelectorAll('.option-input input').forEach(input => {
                    if (input.value) question.options.push(input.value);
                });
            }

            questions.push(question);
        });

        const data = {
            title: title,
            description: description,
            endDate: endDate || null,
            isActive: isActive,
            questions: questions
        };

        fetch('/Survey/Edit/@Model.Id', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('✅ Anket başarıyla güncellendi!');
                window.location.href = '/Survey/Details/@Model.Id';
            } else {
                alert('❌ Bir hata oluştu: ' + (data.message || ''));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('❌ Bir hata oluştu!');
        });
    }
</script>

<style>
    .question-card {
        transition: all 0.2s;
        border-left: 4px solid #0d6efd;
    }

        .question-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
</style>